<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Test - Fixed</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .form-group { margin: 10px 0; }
        .form-group label { display: block; margin-bottom: 5px; }
        .form-group input { width: 100%; padding: 8px; margin-bottom: 10px; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .messages { border: 1px solid #ccc; height: 400px; overflow-y: auto; padding: 10px; margin: 20px 0; }
        .message { margin: 5px 0; padding: 5px; background: #f5f5f5; border-radius: 5px; }
        .system { background: #e7f3ff; }
        .sent { background: #e7ffe7; }
        .received { background: #fff7e7; }
        .error { background: #ffe7e7; color: red; }
    </style>
</head>
<body>
    <div class="container">
        <h1>WebSocket Test - After Fix</h1>
        
        <div class="form-group">
            <label>JWT Token (optional for development):</label>
            <input type="text" id="token" placeholder="Enter your JWT access token (leave empty to test as anonymous)">
        </div>
        
        <div class="form-group">
            <label>Room ID:</label>
            <input type="text" id="roomId" value="test_room" placeholder="Enter room ID">
        </div>
        
        <button onclick="connect()">Connect</button>
        <button onclick="disconnect()">Disconnect</button>
        
        <div class="form-group">
            <label>Message:</label>
            <input type="text" id="messageInput" placeholder="Enter your message" onkeypress="if(event.key==='Enter') sendMessage()">
        </div>
        
        <button onclick="sendMessage()">Send Message</button>
        
        <div id="messages" class="messages"></div>
        
        <h3>Test Instructions:</h3>
        <ol>
            <li><strong>Anonymous Test:</strong> Leave token field empty and try to connect</li>
            <li><strong>Authenticated Test:</strong> Get a token from login and use it</li>
            <li><strong>Both should work now!</strong> Anonymous users can connect and send messages (for development)</li>
        </ol>
    </div>

    <script>
        let socket = null;
        
        function addMessage(content, type = 'system') {
            const messages = document.getElementById('messages');
            const div = document.createElement('div');
            div.className = `message ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${content}`;
            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
        }
        
        function connect() {
            const token = document.getElementById('token').value;
            const roomId = document.getElementById('roomId').value;
            
            if (!roomId) {
                addMessage('Please enter a room ID', 'error');
                return;
            }
            
            let wsUrl = `ws://127.0.0.1:8002/ws/chat/${roomId}/`;
            if (token) {
                wsUrl += `?token=${token}`;
            }
            
            addMessage(`Connecting to: ${wsUrl}`, 'system');
            
            socket = new WebSocket(wsUrl);
            
            socket.onopen = function(e) {
                addMessage('Connected successfully!', 'system');
            };
            
            socket.onmessage = function(e) {
                try {
                    const data = JSON.parse(e.data);
                    addMessage(`Received: ${JSON.stringify(data, null, 2)}`, 'received');
                } catch (error) {
                    addMessage(`Received (raw): ${e.data}`, 'received');
                }
            };
            
            socket.onclose = function(e) {
                addMessage(`Connection closed (code: ${e.code})`, 'system');
            };
            
            socket.onerror = function(e) {
                addMessage(`WebSocket error: ${e}`, 'error');
            };
        }
        
        function disconnect() {
            if (socket) {
                socket.close();
                socket = null;
                addMessage('Disconnected', 'system');
            }
        }
        
        function sendMessage() {
            if (!socket || socket.readyState !== WebSocket.OPEN) {
                addMessage('Not connected to WebSocket', 'error');
                return;
            }
            
            const messageContent = document.getElementById('messageInput').value;
            
            if (!messageContent) {
                addMessage('Please enter a message', 'error');
                return;
            }
            
            addMessage(`Sending: ${messageContent}`, 'sent');
            socket.send(messageContent);
            
            document.getElementById('messageInput').value = '';
        }
    </script>
</body>
</html>